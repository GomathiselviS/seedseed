---
- name: Seeding Custom Playbooks
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Get Custom Playbooks content
      ansible.builtin.git:
        repo: '{{ seed_custom_cac_url }}'
        dest: '{{ seed_custom_cac_url.split("/")[-1] }}'

    - name: Get all experiences in collection
      ansible.builtin.find:
        paths: '{{ seed_custom_cac_url.split("/")[-1] }}'
        patterns: setup.yml
        recurse: true
      register: experiences

    - block:
        - name: Include vars
          ansible.builtin.include_vars:
            file: '{{ item.path }}'

        - name: Execute automation controller resource configuration
          ansible.builtin.include_role:
            name: infra.controller_configuration.dispatch
          vars:
            controller_configuration_async_delay: 1
            controller_configuration_async_retries: 30

      loop: '{{ experiences.files }}'
